{% extends 'base.html' %}
{% load static %}
{% load can_create_app %}

{% block title %}Project overview{% endblock %}

{% block content %}

{% if project.status == "active" %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'projects:index' %}">My projects</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ project.name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between">
    <h3>{{ project.name }}</h3>
    <a href="{%  url 'projects:settings' request.user project.slug %}" class="btn btn-primary">
        <i class="bi bi-gear me-1"></i>
        Settings
    </a>
</div>

<div class="row my-2">
     <div class="col">
        {% if project.description %}
            <p class="card-text"><b>Description:</b> {{ project.description }}</p>
            {% endif %}
            <p><b>Project owner:</b> {{ project.owner.email }}</p>
            {% if project.authorized.all %}
            <p><b>Project members:</b> {% for user in project.authorized.all %}{{ user.email }}; {% endfor %}</p>
            {% endif %}
    </div>
</div>

<div class="row g-4">
    {% for objs in resources %}
    <div class="col-12 d-flex">
        <div class="card w-100 border">
            <div class="card-header border-bottom-0 bg-white d-flex align-items-center justify-content-between py-3"
                style="min-height: 3rem;">
                <h5 class="card-title mb-0">{{ objs.title }}</h5>
            </div>
            {% if objs.objs %}
            <div class="no-footer mx-2">

                <table id="datatables-dashboard-projects-{{ forloop.counter }}"
                    class="table table-striped my-0 no-footer table-bordered" role="grid">
                    <thead>
                        <tr>
                            <th class="d-none d-xxl-table-cell " tabindex="0" rowspan="1" colspan="1"></th>
                            <th tabindex="0" rowspan="1" colspan="1">App</th>
                            <th tabindex="0" rowspan="1" colspan="1">Name</th>
                            <th class="d-none d-xxl-table-cell " tabindex="0" rowspan="1" colspan="1">Created</th>
                            <th class="" tabindex="0" rowspan="1" colspan="1">Status</th>
                            <th class="d-none d-md-table-cell " tabindex="0" rowspan="1" colspan="1">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for obj in objs.objs %}
                        <tr class="odd">

                            {% static 'images/logos/apps/' as static_url %}
                            <td><img src="{{static_url}}{{obj.app.logo|default:'default-logo.png'}}" class="img-fluid "
                                    alt="App Logo" style="max-height:25px;"></td>
                            <td class="d-none d-xxl-table-cell">{{ obj.app.name }}</td>
                            {% if obj.table_field.url %}
                            <td class="sorting_1">
                                <a href="{{ obj.table_field.url }}" target="_blank">
                                    {{obj.name}} <i class="bi bi-box-arrow-up-right"></i>
                                </a>
                            </td>
                            {% else %}
                            <td class="sorting_1">{{ obj.name }}</td>
                            {% endif %}
                            <td class="d-none d-xxl-table-cell">{{ obj.created_on | date:"d/n/y H:i" }}</td>
                            <td id="status-{{ obj.pk }}">
                                <span class="badge bg-secondary">
                                    {{ obj.status.latest.status_type }}
                                </span>
                            </td>
                            <td class="table-action text-center">
                                <div class="dropdown show">
                                    <a href="#" class="default" data-bs-toggle="dropdown" data-display="static">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-end">
                                        <a class="dropdown-item disabled default"
                                            href="{% url 'apps:logs' request.user project.slug obj.pk %}">
                                            <i class="bi bi-activity me-1"></i>
                                            Logs (disabled)
                                        </a>

                                        {% if obj.app.user_can_edit %}

                                        <a class="dropdown-item default"
                                            href="{% url 'apps:appsettings' request.user project.slug obj.pk %}?from=overview">
                                            <i class="bi bi-sliders2-vertical me-1"></i>
                                            Settings
                                        </a>
                                        {% else %}

                                        <a class="dropdown-item default disabled">
                                            <i class="bi bi-sliders2-vertical me-1"></i>
                                            Settings
                                        </a>
                                        {% endif %}

                                        {% if obj.app.user_can_delete %}

                                        <a class="dropdown-item bg-danger text-white confirm-delete default"
                                            href="{% url 'apps:delete' request.user project.slug obj.app.category.slug obj.pk %}?from=overview">
                                            <i class="bi bi-trash me-1"></i>
                                            Delete
                                        </a>
                                        {% else %}

                                        <a class="dropdown-item bg-danger text-white confirm-delete default disabled">
                                            <i class="bi bi-trash me-1"></i>
                                            Delete
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="h-100 p-4 d-flex align-items-center justify-content-center border-bottom">
                <p>No instances.</p>
            </div>
            {% endif %}
                <div class="row g-2 py-2 mx-2">
                {% for app in objs.apps %}
                    <div class="col-12 col-md-4 col-xl-3">
                    <div class="card">
                    <div class="card-body">
                        <div class="row g-0 w-100 h-100">
                            <div class="col-8 d-flex align-items-bottom flex-column">
                                <div class="pt-2">
                                    <h5>{{ app.name }}</h5>
                                </div>
                                <div class="align-items-end d-flex h-100">
                                    <div>
                                        <div class="row">
                                            <div class="col">
                                                <p>{{ app.description }}</p>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="row">
                                                <div class="col">
                                                    {% can_create_app request.user project app as can_create %}

                                                    {% if can_create %}
                                                    <a class="btn btn-primary"
                                                        href="{% url 'apps:create' request.user project.slug app.slug  %}">Create</a>
                                                    {% else %}
                                                    <button class="btn btn-secondary" style="cursor: default;"
                                                        data-bs-toggle="tooltip" data-bs-placement="top"
                                                        data-bs-title="Max number of apps reached">
                                                        Create
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <div class="col-4">

                                {% static 'images/logos/apps/' as static_url %}
                                <img src="{{static_url}}{{app.logo|default:'default-logo.png'}}" class="img-fluid float-end"
                                    style="height:100px;" alt="App Logo">
                            </div>
                        </div>
                    </div>
                    </div>
                    </div>
                {% endfor %}
                </div>
        </div>
    </div>
    {% endfor %}
    <div class="col-12 d-flex">
        <div class="card w-100 border">
            <div class="bg-white py-3 card-header d-flex justify-content-between align-items-center"
                style="min-height: 5rem;">

                <h5 class="card-title mb-0">Models</h5>
            </div>
            {% if models %}
            <div class="no-footer mx-2">

                <table id="datatables-dashboard-projects" class="table table-striped my-0 no-footer table-bordered" role="grid">
                    <thead>
                        <tr>
                            <th scope="col">Name</th>
                            <th class="d-none d-xxl-table-cell" scope="col">
                                Version</th>
                            <th class="d-none d-xxl-table-cell" scope="col">
                                Created</th>
                            <th scope="col">Status</th>
                            <th class="d-none d-md-table-cell" scope="col">
                                Accessability</th>
                            <th class="d-none d-md-table-cell" scope="col">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for model in models %}
                        <tr class="odd">
                            <td class="sorting_1">{{ model.name }}</td>
                            <td class="d-none d-xxl-table-cell">{{ model.version }}</td>
                            <td class="d-none d-xxl-table-cell">{{ model.uploaded_at | date:"d/n/y H:i" }}</td>
                            <td><span class="badge
                                        {% if model.status == 'CR' %}bg-warning
                                        {% elif model.status == 'DP' %}bg-success
                                        {% elif model.status == 'AR' %}bg-danger
                                        {% endif %}">{{ model.get_status_display }}</span></td>
                            <td class="d-none d-md-table-cell">{{ model.get_access_display }}</td>
                            <td class="table-action text-center">
                                <div class="dropdown show">
                                    <a href="#" data-bs-toggle="dropdown" data-display="static">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-end">
                                        <a class="dropdown-item default"
                                            href="{% url 'models:details_private' request.user project.slug model.pk %}">
                                            <i class="bi bi-text-center me-1"></i>
                                            Details
                                        </a>

                                        {% if model.access != "PU" %}
                                        <a class="dropdown-item default"
                                            href="{% url 'models:publish_model' request.user project.slug model.id %}">
                                            <i class="bi bi-share me-1"></i>
                                            Publish
                                        </a>
                                        {% else %}
                                        <a class="dropdown-item default"
                                            href="{% url 'models:unpublish_model' request.user project.slug model.id %}">
                                            <i class="bi bi-slash-circle me-1"></i>
                                            Unpublish
                                        </a>
                                        {% endif %}

                                        {% include 'common/serve_model_link.html' %}

                                        <a class="dropdown-item default bg-danger text-white confirm-delete"
                                            href="{% url 'models:delete' request.user project.slug model.pk %}">
                                            <i class="bi bi-trash me-1"></i>
                                            Delete
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="h-100 p-4 d-flex align-items-center justify-content-center">
                    <p>No models have been uploaded to this project yet.</p>
                </div>
                {% endif %}
                <div class="h-100 p-4 d-flex">
                 Placeholder for model options
                </div>
            </div>
        </div>
    </div>

    <script>
        {
            const apps = JSON.parse("{{ app_ids|escapejs }}")
            const body = new FormData()
            body.append("apps", apps)

            const url = "{% url 'apps:get_status' request.user project.slug %}"
            const csrftoken = getCookie('csrftoken');

            const updateStatus = async () => {

                const response = await fetch(url, {
                    method: "POST",
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body
                })

                const json = await response.json()

                for (const key in json) {
                    if (Object.hasOwnProperty.call(json, key)) {

                        const { status, statusGroup } = json[key]
                        const querySelector = `#status-${key} > span`
                        const element = document.querySelector(querySelector)
                        const className = `badge bg-${statusGroup}`

                        element.className = className
                        element.innerText = status
                    }
                }
            }

            const loop = async () => {

                if ((apps?.length ?? 0) > 0) {

                    await updateStatus()

                    setTimeout(() => {
                        loop()
                    }, 5000)
                }
            }

            loop()
        }
    </script>
</div>
    {% else %}

    <div class="row">
        <div class="col d-flex justify-content-center">

            {% include 'common/loader.html' %}
        </div>
    </div>

    <script>
        {

            const url = "{% url 'projects:get_status' request.user project.slug %}"
            const csrftoken = getCookie('csrftoken');

            const getStatus = async () => {

                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/json',
                        'X-CSRFToken': csrftoken,
                    }
                })

                const json = await response.json()

                if (json.status !== "created") {
                    window.location.reload()
                }
            }

            const loop = async () => {

                await getStatus()

                setTimeout(() => {
                    loop()
                }, 2000)
            }

            loop()

        }
    </script>

    {% endif %}




    {% endblock %}
