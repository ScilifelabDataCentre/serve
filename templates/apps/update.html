{% extends 'base.html' %}
{% block title %}Settings - {{ app.name }}{% endblock %}
{% load static %}
{% load custom_tags %}

{% block content %}

<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'projects:index' %}">My projects</a></li>
      <li class="breadcrumb-item"><a href="{% url 'projects:details' request.user project.slug %}">{{ project.name }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">Update {{ app.name }}</li>
    </ol>
</nav>

<h1 class="h3 mb-3">Settings {{ app.name }}</h1>
<div class="row">
    <div class="col-12 mt-2 mb-4">
        {% if app.slug == 'customapp' %}
        <p>This form allows you to host an app that fulfills certain requirements on SciLifeLab Serve (the app itself can be built on any framework). Please read our <a href="/docs/application-hosting/other/">documentation page on custom apps</a> for the list of requirements and step-by-step instructions on deployment.</p>
        {% elif app.slug == 'dashapp' %}
        <p>This form allows you to host a Dash app at SciLifeLab Serve. Please read our <a href="/docs/application-hosting/dash/">documentation page on Dash apps</a> for step-by-step instructions.</p>
        {% elif app.slug in 'shinyapp,shinyproxyapp' %}
        <p>This form allows you to host a Shiny app at SciLifeLab Serve. Please read our <a href="/docs/application-hosting/shiny/">documentation page on Shiny apps</a> for step-by-step instructions.</p>
        {% endif %}
        {% if app.slug in 'jupyter-lab,rstudio,vscode' %}
        <p>Note that <b>after 7 days the created {{ app.name }} instance will be deleted</b>, only the files saved in 'project-vol' will stay available.</p>
        <p>Each {{ app.name }} instance can get access to the persistent volume (folder) associated with this project, called 'project-vol'. Please make sure to save all your data files, script files, output from computations, etc. inside 'project-vol'; the files located elsewhere can be deleted at any point. The files saved inside 'project-vol' will be available across all instances of {{ app.name }} (as well as other apps) within this project.</p>
        {% endif %}
    </div>
</div>

<div class="row pt-3">
    <div class="col-12 col-xl-6">
        <div class="card shadow border-0">
            <form class="needs-validation" method="post" novalidate>
                {% csrf_token %}
                <div class="card-body">
                    <input type="hidden" id="app_id" name="app_id" value="{{ appinstance.pk }}">
                    <div class="mb-3 validate-item">
                        <label class="form-label">Name</label>
                        <span class="bi bi-question-circle" style="color: #989da0" data-bs-toggle="tooltip" title="" data-bs-placement="right" data-bs-original-title="Display name for the application. This is the name visible on the app catalogue if the app is public">
                        </span>
                        <input type="text" id="app_name" name="app_name" value="{{ existing_app_name }}"
                            class="form-control" required>
                        <div class="invalid-feedback">
                            Please add a valid name!
                        </div>
                    </div>

                    {% if do_display_description_field %}
                    <div class="mb-3 validate-item">
                        <label class="form-label">Description</label>
                        <span class="bi bi-question-circle" style="color: #989da0" data-bs-toggle="tooltip" title="" data-bs-placement="right" data-bs-original-title="Summarize the application in a few words">
                        </span>
                        <textarea type="text" id="app_description" name="app_description"
                            class="form-control" rows="2" required>{{ existing_app_description }}</textarea>
                        <div class="invalid-feedback">
                            Please add a description of the app!
                        </div>
                    </div>
                    {% endif %}
                    {% if do_display_description_field or request.user.is_superuser %}
                    <div id="subdomain" class="mb-3">
                        <label class="form-label">Subdomain (under {{domain}})</label>
                        <span class="bi bi-question-circle" style="color: #989da0" data-bs-toggle="tooltip" title="" data-bs-placement="right" data-bs-original-title="A subdomain is automatically generated for the app. If you want to create a custom subdomain, click on New">
                        </span>
                        <div class="input-group">
                            <select name="app_release_name" id="app_release_name" type="text" class="form-control" formnovalidate="formnovalidate">
                                <option value="" {% if not request.GET.rn %}selected{% endif %}>---- Generated ----</option>
                                <option value="{{ existing_app_release_name }}" {% if not request.GET.rn %}selected{% endif %}>{{ existing_app_release_name }}.{{domain}}</option>
                            {% for item in form.release_names %}
                                {% if item.name != existing_app_release_name  %}
                                <option value="{{ item.name }}" {% if request.GET.rn == item.name %}selected{% endif %}>{{ item.name }}.{{domain}}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                            <button class="btn btn-outline-secondary" onclick="toggleSubdomain()" type="button">New</button>
                        </div>
                    </div>
                    <div id="subdomain-add" class="mb-3" style="display: none;">
                        <label class="form-label">New Subdomain</label>
                        <span class="bi bi-question-circle" style="color: #989da0" data-bs-toggle="tooltip" title="" data-bs-placement="right" data-bs-original-title="Valid subdomain names are those that have letters a-z and numbers 0-9 and a hyphen '-'. The hyphen should not be at the start or end of the subdomain">
                        </span>
                        <div class="input-group">
                            <input id="rn" type="text" class="form-control" placeholder="New Subdomain ..." name="rn">
                            <button onclick="submitDomain()" type="button" class="btn btn-outline-secondary">Add</button>
                            <div class="valid-feedback">Subdomain Added</div>
                            <div id="subdomain-invalid" class="invalid-feedback">Subdomain already exists. Please choose another.</div>
                        </div>
                    </div>
                    {% endif %}
                    {% if form.dep_permissions %}
                    <div class="mb-3">
                        <label class="form-label">Permissions</label>
                        <span class="bi bi-question-circle" style="color: #989da0" data-bs-toggle="tooltip" title="" data-bs-placement="right" data-bs-original-title="Public apps will be displayed on the app catalogue and can be accessed by anyone that has the link to them. Project apps can only be accessed by project members. Private apps are only accessible by users that create the apps.">
                        </span>
                        <select {% if not show_permissions %} disabled {% endif %} name="permission" id="permission"
                            class="form-control">
                            {% for name, value in form.form_permissions.items %}
                            {% if value.option == "true" %}
                            {% if value.value %}
                            <option value="{{ name }}" selected>{{ name }}</option>
                            {% else %}
                            <option value="{{ name }}">{{ name }}</option>
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    {% if form.dep_model %}
                    <div class="mb-3">
                        <label class="form-label">Model</label>
                        <span class="bi bi-question-circle" style="color: #989da0" data-bs-toggle="tooltip" title="" data-bs-placement="right" data-bs-original-title="List of model objects created in the project.">
                        </span>
                        <select name="model" id="model" class="form-control">
                            {% for model in form.models %}
                            <option value="{{ model.pk }}" {{ model.selected }}>{{ model.name }}:{{ model.version }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    {% if form.dep_S3 %}
                    <div class="mb-3">
                        <label class="form-label">S3</label>
                        <select name="S3" id="S3" class="form-control">
                            {% for s3 in form.s3stores %}
                            <option value="{{ s3.pk }}" {{ s3.selected }}>{{ s3.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    {% if form.dep_flavor %}
                    <div class="mb-3">
                        <label class="form-label">Hardware</label>
                        <span class="bi bi-question-circle" style="color: #989da0" data-bs-toggle="tooltip" title="" data-bs-placement="right" data-bs-original-title="Hardware allocation for your app. Only one option is available by default. If your app requires more hardware resources, get in touch with us (serve@scilifelab.se) with a request.">
                        </span>
                        <select name="flavor" id="flavor" class="form-control">

                            {% for flavor in form.current_flavor %}
                                <option value="{{ flavor.pk }}">{{ flavor.name }} (active)</option>
                            {% endfor %}
                            {% for flavor in form.flavors %}
                                <option value="{{ flavor.pk }}">{{ flavor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    {% if form.dep_environment %}
                    {% if form.environments.objs.count > 0 %}
                    <div class="mb-3">
                        <label class="form-label">{{ form.environments.title }}</label>
                        <select name="environment" id="environment" class="form-control">
                            {% for environment in form.environments.objs %}
                            {% if environment.pk == form.environments.selected %}
                            <option value="{{ environment.pk }}" selected>{{ environment.name }}</option>
                            {% else %}
                            <option value="{{ environment.pk }}">{{ environment.name }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    {% endif %}

                    {% if form.dep_apps %}
                    {% for app_name, appinstances in form.app_deps.items %}
                    <div class="mb-3">
                        <label class="form-label">{{ app_name }}</label>
                        <select name="app:{{ app_name }}" id="{{ app_name }}" class="form-control" {{
                            appinstances.option_type }} required>
                            {% if app_name == "Persistent Volume" %}
                                {% if current_volume %}
                                    <option value="{{ current_volume.pk }}" selected>{{ current_volume.name }} (active)</option>
                                {% endif %}

                                {% if not current_volume %}
                                    <option value="None" selected>None (active)</option>
                                {% endif %}

                                {% for appinstance in available_volumes %}
                                    <option value="{{ appinstance.pk }}">{{ appinstance.name }}</option>
                                {% endfor %}

                                {% if current_volume %}
                                    <option value="None">None</option>
                                {% endif %}

                            {% else %}
                                {% for appinstance in appinstances.instances %}
                                <option value="{{ appinstance.pk }}" {{ appinstance.selected }}>{{ appinstance.name }}
                                </option>
                                {% endfor %}
                            {% endif %}

                        </select>
                    </div>
                    {% endfor %}
                    {% endif %}


                    {% for key, vals in form.primitives.items %}

                    <h6> {{ vals.meta_title }}</h6>
                    {% for subkey, subval in vals.items %}
                    {% if subval.type != "boolean" and  subkey == "image" or subkey == "port" or subkey == "path" %}
                    <div class="mb-3 form-group validate-item">
                    {% else %}
                    <div class="mb-3 {% if subkey == "path" %}path_div{% endif %}">
                    {% endif %}
                        {% if subval.type == "boolean" %}
                        <label class="form-label">{{ subval.title }}</label>
                        <select name="{{ key }}.{{ subkey }}" id="{{ subkey }}" class="form-control">
                            {% if subval.default == "False" %}
                            <option value="True">True</option>
                            <option value="False" selected>False</option>
                            {% else %}
                            <option value="True" selected>True</option>
                            <option value="False">False</option>
                            {% endif %}
                        </select>
                        {% endif %}

                        {% if subval.type == "string" %}
                        <label class="form-label">{{ subval.title }}</label>
                        {% if subkey == "image" %}
                        <span class="bi bi-question-circle" style="color: #989da0" data-bs-toggle="tooltip" title="" data-bs-placement="right" data-bs-original-title="DockerHub or Github Docker Image for the app">
                        </span>
                        <input type="text" id="{{ subkey }}" name="{{ key }}.{{ subkey }}" value="{{ subval.default }}" class="form-control" required>
                        <div class="invalid-feedback">
                            Please add a valid image name!
                        </div>
                        {% elif subkey == "path" %}
                        <span class="bi bi-question-circle" style="color: #989da0" data-bs-toggle="tooltip" title="" data-bs-placement="right" data-bs-original-title="Specify the path inside the container that you want to be persistent (path to database or similar). If you follow our guide to build the container then please include the username int the path as well.">
                        </span>
                        {% if request.user.is_superuser  %}
                        <input type="hidden" id="admin" name="admin" value="true">
                        <input type="text" id="{{ subkey }}" name="{{ key }}.{{ subkey }}" value="{{ existing_path }}" placeholder="{{ subval.default }}" class="form-control">
                        <div class="invalid-feedback">
                            Please add a valid path!
                        </div>
                        {% else %}
                        <div class="input-group mb-3">
                            <span class="input-group-text" id="basic-addon3">/home/</span>
                            <input type="text" id="{{ subkey }}" name="{{ key }}.{{ subkey }}" value="{{ existing_path }}" placeholder="{{ subval.default }}" class="form-control">
                            <div class="invalid-feedback">
                                Please add a valid path!
                            </div>
                        </div>
                        {% endif %}

                        {% else %}
                        <input type="text" id="{{ subkey }}" name="{{ key }}.{{ subkey }}" value="{{ subval.default }}" class="form-control">
                        {% endif %}
                        {% endif %}

                        {% if subval.type == "textfield" %}
                        <label class="form-label">{{ subval.title }}</label>
                        <textarea id="{{ subkey }}" name="{{ key }}.{{ subkey }}" class="form-control"
                            rows="20">{{ subval.default }}</textarea>
                        {% endif %}

                        {% if subval.type == "password" %}
                        <label class="form-label">{{ subval.title }}</label>

                        <div class="input-group">
                            <input type="password" id="{{ subkey }}" name="{{ key }}.{{ subkey }}"
                                value="{{ subval.default }}" class="form-control">

                            <button type="button" class="btn btn-outline-dark btn-show-password">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button disabled type="button" class="btn btn-outline-dark btn-copy"
                                data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Copy">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                        {% endif %}

                        {% if subval.type == "number" %}
                        <label class="form-label">{{ subval.title }}</label>
                        {% if subkey == "port"%}
                        <span class="bi bi-question-circle" style="color: #989da0" data-bs-toggle="tooltip" title="" data-bs-placement="right" data-bs-original-title="Port that the docker container exposes and the application runs on.">
                        </span>
                        <input type="number" id="{{ subkey }}" name="{{ key }}.{{ subkey }}" placeholder="{{ subval.default }}" value="{{ subval.default }}" class="form-control" required>
                         <div class="invalid-feedback">
                            Please add a valid port!
                        </div>
                        {% else %}
                        <input type="number" id="{{ subkey }}" name="{{ key }}.{{ subkey }}" value="{{ subval.default }}" class="form-control">
                        {% endif %}
                        {% endif %}


                        {% if subval.type == "select" %}

                        <label class="form-label">{{ subval.title }}</label>

                        <select {% if not subval.user_can_edit %} disabled {% endif %} name="{{ key }}.{{ subkey }}"
                            id="{{ subkey }}" class="form-control">
                            {% for item in subval.items %}

                            {% if subval.default == item.value %}
                            <option value="{{item.value}}" selected>{{item.name}}</option>
                            {% else %}
                            <option value="{{item.value}}">{{item.name}}</option>
                            {% endif %}
                            {% endfor %}
                        </select>

                        {% endif %}

                        {% if subval.type == "minio-username" %}
                        <label class="form-label">{{ subval.title }}</label>
                        <input type="text" id="{{ subkey }}" name="{{ key }}.{{ subkey }}" value="{{ appinstance.parameters.credentials.access_key }}" class="form-control">
                        {% endif %}

                        {% if subval.type == "minio-password" %}
                        <label class="form-label">{{ subval.title }}</label>
                        <input type="text" id="{{ subkey }}" name="{{ key }}.{{ subkey }}" value="{{ appinstance.parameters.credentials.secret_key }}" class="form-control">
                        {% endif %}

                    </div>
                    {% endfor %}

                    {% endfor %}

                    {% if form.dep_appobj %}
                    <div class="mb-3">
                        <label class="form-label">{{ form.appobjs.title }}</label>
                        <select name="appobj" id="appobj" class="form-control" {{ appobjs.type }}>
                            {% for app in form.appobjs.objs %}
                            <option value="{{ app.pk }}">{{ app.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <a class="btn btn-danger" href="{{ request.headers.referer }}">Cancel</a>
                    <button class="btn btn-primary" type="submit">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% if app.category.pk == 'serve' %}
<div class="row pt-3">

    <div class="col-12 col-xl-6">

        <div class="card shadow border-0 p-3">
            <h3 class="card-title">Tags</h3>
            <p>Add relevant keywords to help users find your app in our catalog of public apps.</p>

            <form method="POST" action="{% url 'apps:add_tag' request.user project.slug appinstance.pk %}">

                {% csrf_token %}

                <div class="row pt-3">
                    <div class="col-12 col-md-10">

                        {% include 'common/autocomplete.html' with str_list=all_tags id_suffix="tags" name="tag" required=True %}

                    </div>
                    <div class="col-12 col-md-2 pt-3 pt-md-0">

                        <div class="row">
                            <div class="col">
                                <input type="submit" class="btn btn-primary w-100" value="Add">
                            </div>
                        </div>
                    </div>

                </div>

            </form>

            <div class="row pt-3">
                {% with appinstance.tags|split:"," as tags %}
                {% for tag in tags %}
                <div class="col-3 d-flex">
                    <form action="{% url 'apps:remove_tag' request.user project.slug appinstance.pk %}" method="post">
                        {% csrf_token %}
                        <span class="badge bg-primary d-flex align-items-center m-1">
                            {{tag}} <button type="submit" class="btn-close btn-close-white ms-1" name="tag" value="{{tag}}"
                                aria-label="Close"></button>
                        </span>
                    </form>
                </div>
                {% endfor %}

                {% endwith %}
                </div>
            </div>
        </div>
    </div>
{% endif %}
</div>
{% if app.slug == "customapp" %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var pvcField = document.getElementById('Persistent Volume');
        var pathField = document.getElementById('path');
        var pathDiv = document.querySelector('.path_div');

        pvcField.addEventListener('change', function () {
            if (pvcField.value !== 'None') {
                pathField.setAttribute('required', 'required');
                pathDiv.classList.add('validate-item');
            } else {
                pathField.removeAttribute('required');
                pathDiv.classList.remove('validate-item');
            }
        });
    });
</script>
{% endif %}
<script>
    {

        const COPY_STR = "Copy", COPIED_STR = "Copied!"

        const copyBtns = document.querySelectorAll('.btn-copy');
        const showPasswordBtns = document.querySelectorAll('.btn-show-password');

        const resetAll = () => {

            copyBtns.forEach(element => {

                const tooltipInstance = bootstrap.Tooltip.getInstance(element);
                tooltipInstance.setContent({ '.tooltip-inner': COPY_STR });
            })
        }

        copyBtns.forEach(btn => {
            btn.addEventListener('click', () => {

                resetAll();
                const input = btn.parentElement.querySelector('input');
                input.select();
                document.execCommand('copy');

                const tooltipInstance = bootstrap.Tooltip.getInstance(btn);
                tooltipInstance.setContent({ '.tooltip-inner': COPIED_STR });

            });
        });

        showPasswordBtns.forEach(btn => {
            btn.addEventListener('click', () => {

                resetAll();
                const input = btn.parentElement.querySelector('input');
                const copyBtn = btn.parentElement.querySelector('button.btn-copy');
                if (input.type === 'password') {
                    input.type = 'text';
                    btn.innerHTML = '<i class="bi bi-eye-slash"></i>';
                    copyBtn.disabled = false;
                } else {
                    input.type = 'password';
                    btn.innerHTML = '<i class="bi bi-eye"></i>';
                    copyBtn.disabled = true;
                }
            });
        })
    }
</script>
<script>
    // Example starter JavaScript for disabling form submissions if there are invalid fields
    (function () {
    'use strict'
    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.querySelectorAll('.needs-validation')
    var validateGroup = document.getElementsByClassName('validate-item');
    // Loop over them and prevent submission
    Array.prototype.filter.call(forms, function (form) {
        form.addEventListener('submit', function (event) {
            if (form.checkValidity() === false) {
                event.preventDefault();
                event.stopPropagation();
                }
            //Added validation class to all form-groups in need of validation
            for (var i = 0; i < validateGroup.length; i++) {
                validateGroup[i].classList.add('was-validated');
            }
        }, false);
        })
    })()
    function toggleSubdomain() {
        var x = document.getElementById("subdomain-add");
        if (x.style.display === "none") {
            x.style.display = "block";
        } else {
            x.style.display = "none";
        }
    }

    function submitDomain() {
        var rn = document.getElementById('rn').value
        $.ajax({
            type: "POST",
            url: '{% url "apps:create_releasename" request.user project.slug app.slug %}',
            data: {"rn": rn,"csrfmiddlewaretoken": '{{ csrf_token }}'},
            success: function(data){
                if (data.available == "true"){
                    if ($('#rn').hasClass('is-invalid')) {
                        $('#rn').removeClass('is-invalid');
                    }
                    $('#rn').addClass('is-valid');
                    setTimeout(function(){
                        window.location.href = window.location.href.replace( /[\?#].*|$/, "?from=overview&rn="+data.rn );
                    }, 2000);

                } else {
                    if ($('#rn').hasClass('is-valid')) {
                        $('#rn').removeClass('is-valid');
                    }
                    $('#rn').addClass('is-invalid');
                    if (data.available == "invalid") {
                        $('#subdomain-invalid').text("Subdomain is invalid. Only lowercase English letters (a-z), numbers (0-9) and hyphens (-) are allowed; hyphen cannot be the first or last character.");
                    } else {
                        $('#subdomain-invalid').text("Subdomain already exists. Please choose another.");
                    }
                }
            }
            });
        }
</script>
{% endblock %}
